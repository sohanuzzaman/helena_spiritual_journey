---
---

<canvas
  id="sparkle-canvas"
  class="particle-canvas fixed inset-0 z-[1] pointer-events-none"
  aria-hidden="true"></canvas>

<script>
  const prefersReducedMotion = window.matchMedia(
    "(prefers-reduced-motion: reduce)"
  ).matches;

  if (!prefersReducedMotion) {
    const canvas = document.getElementById(
      "sparkle-canvas"
    ) as HTMLCanvasElement;
    const ctx = canvas.getContext("2d");

    if (ctx) {
      let width = window.innerWidth;
      let height = window.innerHeight;
      canvas.width = width;
      canvas.height = height;

      const isMobile = width < 768;
      const PARTICLE_COUNT = isMobile ? 20 : 40;
      const GOLD_GLOW = "#F5D97E";

      interface Particle {
        x: number;
        y: number;
        size: number;
        speedY: number;
        drift: number;
        driftSpeed: number;
        phase: number;
        opacity: number;
        maxOpacity: number;
        life: number;
        maxLife: number;
        fadeInDuration: number;
        fadeOutDuration: number;
      }

      function createParticle(): Particle {
        const maxLife = 4000 + Math.random() * 4000;
        return {
          x: Math.random() * width,
          y: height - Math.random() * height * 0.2,
          size: 1 + Math.random() * 2,
          speedY: 0.2 + Math.random() * 0.3,
          drift: 0,
          driftSpeed: 0.5 + Math.random() * 1,
          phase: Math.random() * Math.PI * 2,
          opacity: 0,
          maxOpacity: 0.4 + Math.random() * 0.4,
          life: 0,
          maxLife,
          fadeInDuration: 1000,
          fadeOutDuration: 1000,
        };
      }

      const particles: Particle[] = Array.from(
        { length: PARTICLE_COUNT },
        createParticle
      );

      let lastTime = performance.now();
      let mouseX = width / 2;
      let mouseY = height / 2;
      let isInteracting = false;

      window.addEventListener("mousemove", (e) => {
        mouseX = e.clientX;
        mouseY = e.clientY;
        isInteracting = true;
      });

      window.addEventListener("mouseout", () => {
        isInteracting = false;
      });

      function animate(now: number) {
        const dt = now - lastTime;
        lastTime = now;

        ctx!.clearRect(0, 0, width, height);

        for (let i = 0; i < particles.length; i++) {
          const p = particles[i];
          p.life += dt;

          // Fade in / fade out
          if (p.life < p.fadeInDuration) {
            p.opacity = (p.life / p.fadeInDuration) * p.maxOpacity;
          } else if (p.life > p.maxLife - p.fadeOutDuration) {
            p.opacity =
              ((p.maxLife - p.life) / p.fadeOutDuration) * p.maxOpacity;
          } else {
            p.opacity = p.maxOpacity;
          }

          // Move
          p.y -= p.speedY * (dt / 16);
          p.phase += p.driftSpeed * (dt / 1000);
          p.drift = Math.sin(p.phase) * 20;

          // Mouse subtle repel
          let dx = p.x + p.drift - mouseX;
          let dy = p.y - mouseY;
          let distance = Math.sqrt(dx * dx + dy * dy);

          if (isInteracting && distance < 150) {
            let force = (150 - distance) / 150;
            p.x += (dx / distance) * force * 1.5;
            p.y += (dy / distance) * force * 1.5;
          }

          // Draw
          ctx!.beginPath();
          ctx!.arc(p.x + p.drift, p.y, p.size, 0, Math.PI * 2);
          ctx!.fillStyle = GOLD_GLOW;
          ctx!.globalAlpha = Math.max(0, p.opacity);
          ctx!.fill();

          // Recycle
          if (
            p.life >= p.maxLife ||
            p.y < -10 ||
            p.x < -50 ||
            p.x > width + 50
          ) {
            particles[i] = createParticle();
          }
        }

        ctx!.globalAlpha = 1;
        requestAnimationFrame(animate);
      }

      requestAnimationFrame(animate);

      window.addEventListener("resize", () => {
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;
      });
    }
  }
</script>
